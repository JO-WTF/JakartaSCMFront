<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Pemindaian - Pembaruan Status</title>

  <link rel="stylesheet" href="/assets/css/styles.css" />

  <!-- Vue 3 & ZXing (UMD 全局) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

  <!-- 公共配置 & i18n 核心（提供全局 I18NCore） -->
  <script src="/config.js"></script>
  <script src="/assets/js/i18n/core.js"></script>

  <script>
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());
    let __lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = Date.now();
      if (now - __lastTouchEnd <= 300) {
        const t = e.target;
        if (!t.closest('input, textarea, select, a, button, label, [role="button"]')) e.preventDefault();
      }
      __lastTouchEnd = now;
    }, { passive: false });
    window.addEventListener('wheel', function(e){ if (e.ctrlKey || e.metaKey) e.preventDefault(); }, { passive: false });
  </script>
</head>
<body>
  <div id="app" class="wrap">
    <!-- 语言切换 -->
    <div class="lang-switch">
      <button :class="{active: state.lang==='zh'}" @click="setLang('zh')" aria-label="切换为中文">
        <img src="https://flagcdn.com/w20/cn.png" alt="CN" />中文
      </button>
      <button :class="{active: state.lang==='en'}" @click="setLang('en')" aria-label="Switch to English">
        <img src="https://flagcdn.com/w20/gb.png" alt="GB" />English
      </button>
      <button :class="{active: state.lang==='id'}" @click="setLang('id')" aria-label="Beralih ke Bahasa Indonesia">
        <img src="https://flagcdn.com/w20/id.png" alt="ID" />Indonesia
      </button>
    </div>

    <div><h1>{{ t('scanTitle') }}</h1></div>

    <!-- 扫码区 -->
    <section class="scan-area" v-show="!state.hasDN">
      <div id="interactive" class="viewport"></div>
      <div class="corners">
        <div class="c tl"></div><div class="c tr"></div><div class="c bl"></div><div class="c br"></div>
      </div>
    </section>

    <!-- DN 手动输入 -->
    <div class="did-input card" style="margin-top:12px">
      <label for="dnInput" style="display:block;margin-bottom:6px">{{ t('didLabel') }}</label>
      <div class="did-row" style="display:flex;align-items:center;gap:8px">
        <input
          id="dnInput"
          ref="dnInput"
          class="mono"
          maxlength="20"
          v-model="state.DNID"
          style="flex:1"
          @input="onDNInput" 
        />
        <button
          type="button"
          @click="onOkClick"
          style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;"
        >
          OK
        </button>
      </div>
    </div>
    

    <!-- 闪光灯状态条 -->
    <button
      class="tag"
      v-if="torchTagVisible"
      @click="toggleTorch"
      :aria-pressed="state.torchOn"
      style="cursor:pointer; user-select:none;"
    >
      {{ t('torch') }}：<b>{{ state.torchOn ? t('on') : t('off') }}</b>
    </button>

    <!-- 操作按钮 -->
    <div class="row" v-if="showScanControls">
      <button class="primary" @click="start" :disabled="state.running">{{ t('startScan') }}</button>
      <button class="ghost" @click="stop" :disabled="!state.running">{{ t('stop') }}</button>
      <button class="ghost" @click="nextCamera" :disabled="!state.running">{{ t('switchCamera') }}</button>
    </div>

    <!-- 提交结果 -->
    <div class="card" v-if="state.hasDN">
      <div class="row">
        <button class="primary" @click="resume">{{ t('restart') }}</button>
      </div>

      <template v-if="state.isValid">
        <div class="status-box">
          <div class="status-row" :class="{'shake': state.needsStatusShake}">
            <label for="duStatus">{{ t('updateStatus') }}：</label>
            <select
              id="duStatus"
              class="status"
              :class="{'invalid': state.needsStatusHint}"
              v-model="state.duStatus"
              aria-invalid="true"
              @change="state.needsStatusHint=false; state.needsStatusShake=false"
            >
              <option value="" disabled>{{ t('choose') }}</option>
              <option value="运输中">{{ t('inTransit') }}</option>
              <option value="过夜">{{ t('overnight') }}</option>
              <option value="已到达">{{ t('arrived') }}</option>
            </select>
          </div>
          <div class="hint" v-if="state.needsStatusHint">{{ t('needSelectStatus') }}</div>

          <div class="flex-2">
            <div class="col">
              <label style="display:block;margin-bottom:6px">{{ t('remark') }}</label>
              <textarea v-model="state.remark" :placeholder="t('remarkPlaceholder')"></textarea>
            </div>
            <div class="col">
              <label style="display:block;margin-bottom:6px">{{ t('uploadPhoto') }}</label>
              <div class="uploader">
                <img v-if="state.photoPreview" :src="state.photoPreview" alt="preview" class="thumb" />
                <div style="display:flex;flex-direction:column;gap:8px">
                  <input type="file" accept="image/*" capture="environment" @change="onPickPhoto" />
                  <small class="muted">{{ t('photoTip') }}</small>
                  <button v-if="state.photoFile" class="ghost" @click="clearPhoto">{{ t('removePhoto') }}</button>
                </div>
              </div>
            </div>
          </div>

          <button class="primary" style="align-self:flex-start" @click="submitUpdate" :disabled="!state.isValid || state.submitting">
            {{ state.submitting ? t('submitting') : t('submit') }}
          </button>

          <div v-if="state.submitting">
            <div class="progress" :class="{'indeterminate': !state.photoFile}">
              <div class="progress-bar" :style="{ width: (state.photoFile ? state.uploadPct : 100) + '%' }"></div>
            </div>
            <div class="progress-text">
              {{ state.photoFile ? (t('uploadingPct') + ' ' + state.uploadPct + '%') : t('submittingDots') }}
            </div>
          </div>

          <div v-if="state.submitMsg" :class="[state.submitOk ? 'ok' : 'err']">{{ state.submitMsg }}</div>
        </div>

        <div class="result-box" v-if="state.showResult">
          <h3>{{ t('submittedTitle') }}</h3>
          <div class="result-row"><span class="k">{{ t('duIdLabel') }}:</span><span class="v mono">{{ state.submitView.duId }}</span></div>
          <div class="result-row"><span class="k">{{ t('statusLabel') }}:</span><span class="v">{{ statusLabel(state.submitView.status) }}</span></div>
          <div class="result-row"><span class="k">{{ t('remarkLabel') }}:</span><span class="v">{{ state.submitView.remark || '-' }}</span></div>
          <div class="result-row" v-if="state.submitView.photo">
            <span class="k">{{ t('photoLabel') }}:</span>
            <img :src="state.submitView.photo" class="thumb" alt="thumb" />
          </div>
        </div>
      </template>

      <template v-else>
        <div class="err">{{ t('invalid DN') }}</div>
      </template>
    </div>
  </div>

  <!-- 仅保留这一个入口脚本（唯一挂载） -->
  <script type="module" src="/assets/js/index.js"></script>
</body>
</html>
