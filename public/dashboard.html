<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>配送状态总览（原生 HTML）</title>

    <style>
      :root {
        --bg: #e3f2fd; /* 浅蓝色渐变背景 */
        --card: #ffffff; /* 白色卡片 */
        --ink: #1e3a8a; /* 深蓝色文字 */
        --muted: #4fc3f7; /* 浅蓝色 */
        --line: #e3f2fd; /* 更浅的蓝色线条 */
        --line-100: #bbdefb; /* 更浅的蓝色线条 */
        --brand: #2196f3; /* 浅蓝色按钮 */
        --chip: #1976d2; /* 深蓝色标签 */
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Arial", sans-serif;
        color: var(--ink);
        background: linear-gradient(to bottom, var(--bg), #ffffff);
      }

      .wrap {
        width: 90%;
        margin: 0 auto;
        padding: 24px;
      }

      .header {
        display: flex;
        flex-wrap: wrap;
        gap: 12px 16px;
        align-items: flex-end;
        justify-content: space-between;
        margin-bottom: 16px;
      }

      .title {
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .title .big {
        font-size: clamp(20px, 3.2vw, 32px);
      }

      .sub {
        color: var(--muted);
        font-size: 14px;
        margin-top: 4px;
      }

      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .input {
        width: 220px;
        border: 1px solid var(--line);
        background: #ffffff;
        padding: 8px 12px;
        border-radius: 999px;
        outline: none;
        font-size: 14px;
      }

      .btn {
        border: 1px solid var(--line);
        background: #ffffff;
        color: var(--chip);
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 14px;
        cursor: pointer;
      }

      .btn.primary {
        background: var(--brand);
        border-color: var(--brand);
        color: #ffffff;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 24px;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
        overflow: hidden;
      }

      /* 表格容器 */
      .table-scroll {
        overflow: auto;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 900px;
      }

      thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(227, 242, 253, 0.9);
        backdrop-filter: saturate(180%) blur(6px);
        text-transform: uppercase;
        font-weight: 700;
        font-size: 12px;
        color: var(--chip);
        letter-spacing: 0.06em;
        white-space: normal;
        word-wrap: break-word;
      }

      th,
      td {
        padding: 10px 14px;
        border-bottom: 1px solid var(--line-100);
        text-align: left;
        white-space: nowrap;
      }

      tbody tr:nth-child(odd) {
        background: #e3f2fd66;
      }

      td.num,
      th.num {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      th.sticky,
      td.sticky {
        position: sticky;
        left: 0;
        z-index: 11;
        background: inherit;
        min-width: 220px;
      }

      .chip {
        display: inline-flex;
        height: 24px;
        padding: 0 8px;
        align-items: center;
        border-radius: 999px;
        background: #1976d2;
        color: #ffffff;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .muted {
        color: #f5f5f5;
      }

      tfoot th {
        background: var(--brand);
        color: #ffffff;
        border: none;
      }

      /* 图例与信息卡 */
      .grid {
        display: grid;
        gap: 12px;
      }

      .grid.cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .legend,
      .infocard {
        background: #ffffff;
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .legend .desc {
        color: var(--ink);
        font-size: 14px;
      }

      .infocard .k {
        color: var(--muted);
        font-size: 13px;
      }

      .infocard .v {
        font-size: 28px;
        font-weight: 700;
        margin-top: 2px;
      }

      /* 移动端适配 */
      @media (max-width: 720px) {
        .wrap {
          padding: 16px;
        }

        .controls {
          width: 100%;
        }

        .input {
          flex: 1;
          width: auto;
        }

        table {
          min-width: 720px;
        }

        .grid.cols-3 {
          grid-template-columns: 1fr;
        }
      }

      /* 超小屏提供卡片视图（自动显示） */
      @media (max-width: 560px) {
        .table-section {
          display: none;
        }

        .cards-section {
          display: block;
        }
      }

      .cards-section {
        display: none;
      }

      .rowcard {
        background: #ffffff;
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 12px;
      }

      .rowcard + .rowcard {
        margin-top: 10px;
      }

      .rowcard .head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .kv {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 6px 10px;
        font-size: 13px;
      }

      .kv div {
        display: contents;
      }

      .kv span.label {
        color: var(--muted);
      }

      .kv span.val {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }
      /* 遮罩层样式 */
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.5); /* 半透明黑色背景 */
        display: flex;
        justify-content: center; /* 水平居中 */
        align-items: center; /* 垂直居中 */
        z-index: 9999; /* 确保遮罩层在最上层 */
      }

      /* 旋转的加载图标 */
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid transparent; /* 透明的边框，形成圆形 */
        border-top: 5px solid #3498db; /* 设置顶部的蓝色边框，形成旋转效果 */
        border-radius: 50%; /* 圆形 */
        animation: spin 1s linear infinite; /* 旋转动画 */
      }

      /* 旋转动画 */
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header class="header">
        <div>
          <div class="title"><span class="big">配送状态总览</span></div>
          <div class="sub" id="meta">数据日期：— ・ 总计 —</div>
        </div>
        <div class="controls">
          <input id="q" class="input" placeholder="筛选区域/项目…" />
          <button
            id="toggleZero"
            class="btn primary"
            title="切换是否弱化为 0 的单元格"
          >
            高亮非零
          </button>
          <button id="dl" class="btn">导出 CSV</button>
        </div>
      </header>

      <!-- 关键指标 -->
      <section class="grid cols-3" style="margin: 16px 0">
        <div class="infocard">
          <div>
            <div class="k">POD 总量</div>
            <div id="podTotal" class="v">—</div>
            <div class="k">已完成交付数量</div>
          </div>
        </div>
        <div class="infocard">
          <div>
            <div class="k">异常/重排</div>
            <div id="replanTotal" class="v">—</div>
            <div class="k">需跟进的重排类条目</div>
          </div>
        </div>
        <div class="infocard">
          <div>
            <div class="k">已关闭/取消</div>
            <div id="closedTotal" class="v">—</div>
            <div class="k">关闭与取消合计</div>
          </div>
        </div>
      </section>

      <!-- 表格视图（平板/桌面优先） -->
      <section class="table-section card">
        <div class="table-scroll">
          <table id="tbl">
            <thead>
              <tr id="thead-row">
                <!-- 动态填充表头 -->
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- 动态填充 -->
            </tbody>
            <tfoot>
              <tr id="tfoot-row">
                <!-- 动态填充合计 -->
              </tr>
            </tfoot>
          </table>
        </div>
        <div
          class="grid cols-3"
          style="
            padding: 12px;
            border-top: 1px solid var(--line);
            background: #f8fafc;
          "
        >
          <div class="legend">
            <span class="chip">POD</span><span class="desc">已交付证明</span>
          </div>
          <div class="legend">
            <span class="chip">WAITING PIC FEEDBACK</span
            ><span class="desc">等待图片反馈</span>
          </div>
          <div class="legend">
            <span class="chip">REPLAN MOS…</span
            ><span class="desc">因项目/LSP 延误需要重排</span>
          </div>
        </div>
      </section>

      <!-- 超小屏卡片视图（<560px） -->
      <section class="cards-section">
        <div id="cards"></div>
      </section>
    </div>
    <!-- 遮罩层 -->
    <div id="loading">
      <!-- 旋转加载图标 -->
      <div class="spinner"></div>
    </div>
    <script>
      let opts = {
          lines: 13,
          length: 28,
          width: 14,
          radius: 42,
          scale: 1,
          corners: 1,
          color: "#FFF",
          opacity: 0.25,
          rotate: 0,
          direction: 1,
          speed: 1,
          trail: 60,
          fps: 20,
          zIndex: 2e9,
          className: "spinner",
          top: "50%",
          left: "50%",
          shadow: false,
          hwaccel: false,
          position: "absolute",
        },
        target = document.getElementById("loading"),
        spinner = new Spinner(opts).spin(target);
    </script>
    <script>
      /* —— 数据 —— */
      const STATUS_ORDER = [
        "PREPARE VEHICLE",
        "ON THE WAY",
        "ON SITE",
        "POD",
        "REPLAN MOS PROJECT",
        "WAITING PIC FEEDBACK",
        "REPLAN MOS DUE TO LSP DELAY",
        "CLOSE BY RN",
        "CANCEL MOS",
        "NO STATUS",
        "TOTAL",
      ];

      // 加载数据函数
      async function loadData(date) {
        const loadingElement = document.getElementById("loading");
        loadingElement.style.visibility = "show";

        try {
          const response = await fetch(
            `https://jakartabackend-pr-8.onrender.com/api/dn/stats/${date}`
          );
          const data = await response.json();

          // 渲染数据
          render(data["data"]);
        } catch (error) {
          console.error("加载数据失败:", error);
        } finally {
          loadingElement.style.visibility = "hidden";
        }
      }

      /* —— 状态 —— */
      let mutedZero = true; // 是否弱化 0
      let sortKey = "group"; // 'group' 或 0..9
      let sortDir = "asc";
      let query = "";
      let RAW_ROWS = []; // 动态数据将被存储在此变量中

      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      function fmtDate(iso) {
        const d = new Date(iso + "T00:00:00");
        return d.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "2-digit",
        });
      }

      function computeTotals(rows) {
        const sums = new Array(STATUS_ORDER.length).fill(0);
        rows.forEach((r) => r.values.forEach((v, i) => (sums[i] += v)));
        return sums;
      }

      function currentRows() {
        const q = query.trim().toLowerCase();
        let rows = RAW_ROWS.filter((r) =>
          q ? r.group.toLowerCase().includes(q) : true
        );
        rows = rows.slice().sort((a, b) => {
          if (sortKey === "group")
            return sortDir === "asc"
              ? a.group.localeCompare(b.group)
              : b.group.localeCompare(a.group);
          const i = Number(sortKey);
          const av = a.values[i] ?? 0;
          const bv = b.values[i] ?? 0;
          return sortDir === "asc" ? av - bv : bv - av;
        });
        console.log(rows);
        return rows;
      }

      function render(data) {
        RAW_ROWS = data; // 使用从接口获取的数据

        const rows = currentRows();
        console.log(rows);
        const totals = computeTotals(RAW_ROWS);
        console.log(totals);

        // 顶部 meta
        $("#meta").textContent = `数据日期：${RAW_ROWS[0].date} ・ 总计 ${
          totals[totals.length - 1]
        }`;

        // 指标卡
        $("#podTotal").textContent = totals[3];
        $("#replanTotal").textContent = totals[4] + totals[6];
        $("#closedTotal").textContent = totals[7] + totals[8];

        // 表头
        const thead = $("#thead-row");
        thead.innerHTML = "";
        const thGroup = document.createElement("th");
        thGroup.className = "sticky";
        thGroup.textContent = "区域 / 项目";
        thGroup.dataset.key = "group";
        thead.appendChild(thGroup);
        STATUS_ORDER.forEach((s, idx) => {
          const th = document.createElement("th");
          th.className = "num";
          th.textContent = s;
          th.dataset.key = String(idx);
          thead.appendChild(th);
        });
        // 排序提示
        $$("thead th").forEach((th) => {
          th.style.cursor = "pointer";
          th.onclick = () => onSort(th.dataset.key);
        });
        decorateSortIndicators();

        // 表体
        const tb = $("#tbody");
        tb.innerHTML = "";
        rows.forEach((row, ri) => {
          const tr = document.createElement("tr");
          const td0 = document.createElement("td");
          td0.className = "sticky";

          // 提取项目名称并只展示一次
          const [projectName] = row.group.split(" "); // 假设项目名称在第一个空格前
          td0.innerHTML = `<span class="chip">${projectName}</span> <span style="margin-left:6px; white-space: nowrap;">${row.group.replace(
            projectName,
            ""
          )}</span>`;

          tr.appendChild(td0);
          row.values.forEach((v, ci) => {
            const td = document.createElement("td");
            td.className = "num";
            td.title = STATUS_ORDER[ci];
            if (mutedZero && v === 0) td.classList.add("muted");
            if (v > 0 && ci === 3) td.style.fontWeight = "700";
            td.textContent = v;
            tr.appendChild(td);
          });
          tb.appendChild(tr);
        });

        // 合计
        const tf = $("#tfoot-row");
        tf.innerHTML = "";
        const th0 = document.createElement("th");
        th0.className = "sticky";
        th0.textContent = "合计";
        tf.appendChild(th0);
        totals.forEach((t) => {
          const th = document.createElement("th");
          th.className = "num";
          th.textContent = t;
          tf.appendChild(th);
        });

        // 小屏卡片视图
        const cards = $("#cards");
        cards.innerHTML = "";
        rows.forEach((row) => {
          const div = document.createElement("div");
          div.className = "rowcard";
          div.innerHTML = `
        <div class="head">
          <div><span class="chip">${
            row.group.includes("IOH")
              ? "IOH"
              : row.group.includes("TSEL")
              ? "TSEL"
              : "XLS"
          }</span> <strong style="margin-left:6px;">${row.group}</strong></div>
          <small style="color:#64748b">${fmtDate(row.date)}</small>
        </div>
        <div class="kv">
          ${STATUS_ORDER.map(
            (s, i) =>
              `<div><span class="label">${s}</span><span class="val ${
                mutedZero && row.values[i] === 0 ? "muted" : ""
              }">${row.values[i]}</span></div>`
          ).join("")}
        </div>`;
          cards.appendChild(div);
        });
      }

      function decorateSortIndicators() {
        $$("thead th").forEach((th) => {
          const key = th.dataset.key;
          if (!key) return;
          const arrow =
            sortKey === key ? (sortDir === "asc" ? " ▲" : " ▼") : "";
          const base = th.textContent.replace(/[ ▲▼]+$/, "");
          th.textContent = base + arrow;
        });
      }

      function onSort(key) {
        if (!key) return;
        if (sortKey === key) sortDir = sortDir === "asc" ? "desc" : "asc";
        else {
          sortKey = key;
          sortDir = key === "group" ? "asc" : "desc";
        }
        render();
      }

      // 事件绑定
      $("#q").addEventListener("input", (e) => {
        query = e.target.value;
        render();
      });
      $("#toggleZero").addEventListener("click", () => {
        mutedZero = !mutedZero;
        $("#toggleZero").classList.toggle("primary", mutedZero);
        $("#toggleZero").textContent = mutedZero ? "高亮非零" : "显示全部";
        render();
      });
      $("#dl").addEventListener("click", () => {
        const rows = currentRows();
        const header = ["区域/项目", ...STATUS_ORDER].join(",");
        const lines = rows.map((r) => [r.group, ...r.values].join(","));
        const csv = [header, ...lines].join("\n");

        const blob = new Blob(["﻿" + csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `配送状态_${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });

      // 初始加载数据
      loadData("19-Sep-25"); // 假设我们要加载的日期为 "2025-09-19"
    </script>
  </body>
</html>
