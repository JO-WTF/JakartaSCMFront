<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>index</title>
    <meta name="description" content="" />
    <meta name="author" content="Christoph Oberhofer" />
    <meta name="viewport" content="width=device-width; initial-scale=1.0; user-scalable=no" />
    <link rel="stylesheet" href="test.css">
</head>

<body>
    <section id="container" class="container">
        <div class="controls">
            <fieldset class="input-group">
                <button class="stop">Stop</button>
            </fieldset>
            <fieldset class="reader-config-group">
                <label>
                    <span>Half-Sample</span>
                    <input type="checkbox" checked="checked" name="locator_half-sample" />
                </label>
                <label>
                    <span>Camera</span>
                    <select name="input-stream_constraints" id="deviceSelection"></select>
                </label>
            </fieldset>
        </div>
        <div id="result_strip">
            <ul class="thumbnails"></ul>
            <ul class="collector"></ul>
        </div>
        <div id="interactive" class="viewport"></div>
    </section>

    <script src="https://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script>
    <script src="//webrtc.github.io/adapter/adapter-latest.js" type="text/javascript"></script>
    <script src="https://serratus.github.io/quaggaJS/examples/js/quagga.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {

            var App = {
                init: function () {
                    var self = this;
                    Quagga.init(this.state, function (err) {
                        if (err) {
                            console.log(err);
                            return;
                        }
                        App.attachListeners();
                        Quagga.start();
                    });
                },

                initCameraSelection: function () {
                    var streamLabel = Quagga.CameraAccess.getActiveStreamLabel();
                    return Quagga.CameraAccess.enumerateVideoDevices()
                        .then(function (devices) {
                            var $deviceSelection = document.getElementById("deviceSelection");
                            $deviceSelection.innerHTML = ''; // 清空当前选项
                            devices.forEach(function (device) {
                                var $option = document.createElement("option");
                                $option.value = device.deviceId || device.id;
                                $option.appendChild(document.createTextNode(device.label || device.deviceId || device.id));
                                $option.selected = streamLabel === device.label;
                                $deviceSelection.appendChild($option);
                            });
                        });
                },

                attachListeners: function () {
                    var self = this;
                    self.initCameraSelection();
                    $(".controls").on("click", "button.stop", function (e) {
                        e.preventDefault();
                        Quagga.stop();
                    });

                    $(".controls .reader-config-group").on("change", "input, select", function (e) {
                        e.preventDefault();
                        var $target = $(e.target),
                            value = $target.attr("type") === "checkbox" ? $target.prop("checked") : $target.val(),
                            name = $target.attr("name");

                        self.setState(name, value);
                    });
                },

                setState: function (path, value) {
                    this.state[path] = value;
                    console.log(JSON.stringify(this.state));
                    Quagga.stop();
                    App.init();  // 重新初始化以应用更新的配置
                },

                state: {
                    inputStream: {
                        type: "LiveStream",
                        constraints: {
                            width: { min: 1920 },
                            height: { min: 1080 },
                            facingMode: "environment",  // 后置相机
                            aspectRatio: { min: 1, max: 2 }
                        }
                    },
                    locator: {
                        patchSize: "medium", // 默认使用 medium
                        halfSample: true
                    },
                    numOfWorkers: 2,  // 默认使用 2 个 workers
                    frequency: 10,
                    decoder: { readers: [] },
                    locate: true
                }
            };

            App.init();

            Quagga.onProcessed(function (result) {
                var drawingCtx = Quagga.canvas.ctx.overlay,
                    drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                        result.boxes.filter(function (box) {
                            return box !== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, { color: "green", lineWidth: 2 });
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, { color: "#00F", lineWidth: 2 });
                    }

                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, { x: 'x', y: 'y' }, drawingCtx, { color: 'red', lineWidth: 3 });
                    }
                }
            });

            Quagga.onDetected(function (result) {
                var code = result.codeResult.code;

                // 检查条形码是否符合条件
                var prefixes = ['DID', 'KID', 'SDNID', 'MIND', 'CID', 'RFID', 'STRID'];
                var isValid = false;

                // 条形码长度检查，必须在14到18位之间
                if (code.length >= 14 && code.length <= 18) {
                    // 检查条形码是否以指定前缀之一开头
                    prefixes.forEach(function (prefix) {
                        if (code.startsWith(prefix)) {
                            isValid = true;
                        }
                    });
                }

                if (isValid) {
                    var $node = $('<li><div class="thumbnail"><div class="imgWrapper"><img /></div><div class="caption"><h4 class="code"></h4></div></div></li>');
                    $node.find("img").attr("src", Quagga.canvas.dom.image.toDataURL());
                    $node.find("h4.code").html(code);
                    $("#result_strip ul.thumbnails").prepend($node);
                } else {
                    console.log("Invalid barcode detected: " + code);
                }
            });
        });
    </script>
</body>

</html>