<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DU 提交记录查询</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#0b1020;color:#eaf2ff}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#101831;border:1px solid #1f2a4d;border-radius:14px;padding:14px;margin-top:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:#8aa2c8}
    input,select{background:#0e1631;color:#eaf2ff;border:1px solid #2a3a66;border-radius:10px;padding:8px 10px}
    input[type="date"]{min-width:220px}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:700;background:#69a8ff;color:#07122b}
    .ghost{background:#12182b;color:#eaf2ff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #1f2a4d;text-align:left;font-size:14px}
    a{color:#69a8ff}
    .muted{color:#8aa2c8;font-size:12px}
    .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
  </style>
</head>
<body>
<div class="container">
  <h2>DU 提交记录查询</h2>

  <script>
    window.API_BASE = "https://jakartabackend.onrender.com";
  </script>

  <div class="card">
    <div class="row">
      <div>
        <label>DU ID</label><br>
        <input id="f-du" placeholder="10-20 位数字">
      </div>
      <div>
        <label>状态</label><br>
        <select id="f-status">
          <option value="">（全部）</option>
          <option value="运输中">运输中</option>
          <option value="已到达">已到达</option>
        </select>
      </div>
      <div>
        <label>备注关键词</label><br>
        <input id="f-remark" placeholder="模糊匹配">
      </div>
      <div>
        <label>是否带附件</label><br>
        <select id="f-has">
          <option value="">（不限）</option>
          <option value="true">有附件</option>
          <option value="false">无附件</option>
        </select>
      </div>
      <div>
        <label>开始日期</label><br>
        <input id="f-from" type="date">
      </div>
      <div>
        <label>结束日期</label><br>
        <input id="f-to" type="date">
      </div>
      <div>
        <button class="btn" id="btn-search">查询</button>
        <button class="btn ghost" id="btn-reset">重置</button>
        <button class="btn ghost" id="btn-export-all">导出全部</button>
        <button class="btn ghost" id="btn-trust-backend-link">点击去信任后台系统</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="hint" class="muted">输入条件后点击查询。</div>
    <table id="tbl" style="display:none">
      <thead>
        <tr>
          <th>ID</th><th>DU ID</th><th>状态</th><th>备注</th><th>照片</th><th>时间</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pager" id="pager" style="display:none">
      <button class="ghost" id="prev">上一页</button>
      <span id="pginfo" class="muted"></span>
      <button class="ghost" id="next">下一页</button>
    </div>
  </div>
</div>

<script>
  const API_BASE = window.API_BASE || location.origin; // 默认同源
  function toAbsUrl(u){
    if(!u) return "";
    if(/^https?:\/\//i.test(u)) return u;           // 已是绝对地址
    const sep = u.startsWith("/") ? "" : "/";       // 相对路径 → 拼后端域名
    return `${API_BASE}${sep}${u}`;
  }

  const q = { page: 1, page_size: 20 };

  const el = id => document.getElementById(id);
  const tbl = el('tbl');
  const tbody = tbl.querySelector('tbody');
  const hint = el('hint');
  const pager = el('pager');
  const pginfo = el('pginfo');

  function buildParams(){
    const p = new URLSearchParams();
    const du = el('f-du').value.trim();
    const st = el('f-status').value;
    const rk = el('f-remark').value.trim();
    const hp = el('f-has').value;
    const df = el('f-from').value;
    const dt = el('f-to').value;

    if(du) p.set('du_id', du);
    if(st) p.set('status', st);
    if(rk) p.set('remark', rk);
    if(hp) p.set('has_photo', hp);
    if(df){
      const d = new Date(df + "T00:00:00");
      p.set('date_from', d.toISOString());
    }
    if(dt){
      const d = new Date(dt + "T23:59:59");
      p.set('date_to', d.toISOString());
    }
    p.set('page', q.page);
    p.set('page_size', q.page_size);
    return p.toString();
  }

  async function fetchList(){
    try{
      hint.textContent = '加载中…';
      tbl.style.display = 'none';
      pager.style.display = 'none';

      const url = `${API_BASE}/api/du/search?${buildParams()}`;
      const resp = await fetch(url);
      const raw = await resp.text();
      let data = null; try{ data = raw ? JSON.parse(raw) : null }catch{}
      if(!resp.ok){ throw new Error((data && (data.detail||data.message)) || ('HTTP '+resp.status)); }

      const items = Array.isArray(data?.items) ? data.items : [];
      tbody.innerHTML = items.map(it=>{
        const t = it.created_at ? new Date(it.created_at).toLocaleString() : '';
        const link = it.photo_url ? `<a href="${toAbsUrl(it.photo_url)}" target="_blank">查看</a>` : '';
        const remark = it.remark ? it.remark.replace(/[<>]/g,'') : '';
        return `<tr><td>${it.id}</td><td>${it.du_id}</td><td>${it.status}</td><td>${remark}</td><td>${link}</td><td>${t}</td></tr>`;
      }).join('');

      tbl.style.display = '';
      hint.textContent = items.length ? '' : '没有数据';

      const total = data?.total || 0;
      const pages = Math.max(1, Math.ceil(total / q.page_size));
      pginfo.textContent = `第 ${q.page} / ${pages} 页，共 ${total} 条`;
      pager.style.display = (pages > 1) ? '' : 'none';
      el('prev').disabled = (q.page <= 1);
      el('next').disabled = (q.page >= pages);
    }catch(err){
      hint.textContent = '查询失败：' + (err?.message || err);
      tbl.style.display = 'none';
      pager.style.display = 'none';
    }
  }

  el('btn-search').onclick = ()=>{ q.page = 1; fetchList(); };
  el('btn-reset').onclick = ()=>{
    ['f-du','f-status','f-remark','f-has','f-from','f-to'].forEach(id=>{
      const n = el(id);
      if(n.tagName === 'SELECT') n.value = '';
      else n.value = '';
    });
    q.page = 1; fetchList();
  };
  el('prev').onclick = ()=>{ if(q.page>1){ q.page--; fetchList(); }};
  el('next').onclick = ()=>{ q.page++; fetchList(); };

  // CSV 工具：转义单元格
  function csvEscape(val){
    if(val === null || val === undefined) return '';
    const s = String(val);
    // 如果包含逗号、双引号、换行，需要用引号包裹，并把双引号转义为 ""。
    if(/[",\n]/.test(s)){
      return `"${s.replace(/"/g, '""')}"`;
    }
    return s;
  }

  // 生成并下载 CSV 文件
  function downloadCSV(rows, filename='du_export.csv'){
    const bom = '\uFEFF'; // 让 Excel 识别 UTF-8
    const lines = rows.map(r => r.map(csvEscape).join(',')).join('\n');
    const blob = new Blob([bom + lines], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  // 根据记录数组，生成 CSV 数据行（含表头）
  function toCsvRows(items){
    const header = ['ID','DU ID','状态','备注','照片URL','时间'];
    const rows = [header];
    for(const it of items){
      const t = it.created_at ? new Date(it.created_at).toLocaleString() : '';
      const remark = it.remark ? String(it.remark).replace(/[<>]/g,'') : '';
      const photo = it.photo_url ? toAbsUrl(it.photo_url) : '';
      rows.push([it.id, it.du_id, it.status || '', remark, photo, t]);
    }
    return rows;
  }

  // 拉取“全部结果”并导出（遵循当前筛选条件）
  async function exportAll(){
    try{
      hint.textContent = '正在导出全部数据，请稍候…';
      // 先拉一次，拿 total 和首页数据
      const firstParams = new URLSearchParams(buildParams());
      firstParams.set('page', '1');
      firstParams.set('page_size', String(q.page_size)); // 使用当前每页大小
      const firstUrl = `${API_BASE}/api/du/search?${firstParams.toString()}`;

      const firstResp = await fetch(firstUrl);
      const firstRaw = await firstResp.text();
      let firstData = null; try{ firstData = firstRaw ? JSON.parse(firstRaw) : null }catch{}
      if(!firstResp.ok){ throw new Error((firstData && (firstData.detail||firstData.message)) || ('HTTP '+firstResp.status)); }

      const total = firstData?.total || 0;
      let items = Array.isArray(firstData?.items) ? firstData.items.slice() : [];

      // 如果还有更多页，把剩余页也抓回来
      const per = q.page_size || 20;
      const pages = Math.max(1, Math.ceil(total / per));
      for(let p=2; p<=pages; p++){
        const pParams = new URLSearchParams(buildParams());
        pParams.set('page', String(p));
        pParams.set('page_size', String(per));
        const url = `${API_BASE}/api/du/search?${pParams.toString()}`;
        const resp = await fetch(url);
        const raw = await resp.text();
        let data = null; try{ data = raw ? JSON.parse(raw) : null }catch{}
        if(!resp.ok){ throw new Error((data && (data.detail||data.message)) || ('HTTP '+resp.status)); }
        if(Array.isArray(data?.items) && data.items.length){
          items = items.concat(data.items);
        }
      }

      if(!items.length){
        alert('没有匹配的数据可导出。');
        hint.textContent = total ? '' : '没有数据';
        return;
      }

      const rows = toCsvRows(items);
      downloadCSV(rows, 'du_all_results.csv');
      hint.textContent = '';
    }catch(err){
      hint.textContent = '导出失败：' + (err?.message || err);
    }
  }

// —— 将导出按钮与函数绑定 —— //
const exportAllBtn = el('btn-export-all');
exportAllBtn.onclick = async () => {
  try{
    exportAllBtn.disabled = true;
    await exportAll();
  } finally {
    exportAllBtn.disabled = false;
  }
};

const trustBackendLinkBtn = el('btn-trust-backend-link');
trustBackendLinkBtn.onclick = () => {
  window.open("https://jakartabackend.onrender.com", "_blank"); 
};

q.page = 1; fetchList();

</script>
</body>
</html>
