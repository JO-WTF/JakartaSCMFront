<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DU 提交记录查询</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#0b1020;color:#eaf2ff}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#101831;border:1px solid #1f2a4d;border-radius:14px;padding:14px;margin-top:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:#8aa2c8}
    input,select{background:#0e1631;color:#eaf2ff;border:1px solid #2a3a66;border-radius:10px;padding:8px 10px}
    input[type="datetime-local"]{min-width:220px}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:700;background:#69a8ff;color:#07122b}
    .ghost{background:#12182b;color:#eaf2ff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #1f2a4d;text-align:left;font-size:14px}
    a{color:#69a8ff}
    .muted{color:#8aa2c8;font-size:12px}
    .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
  </style>
</head>
<body>
<div class="container">
  <h2>DU 提交记录查询</h2>

  <script>
    window.API_BASE = "https://backend-jwsj.onrender.com";
  </script>

  <div class="card">
    <div class="row">
      <div>
        <label>DU ID</label><br>
        <input id="f-du" placeholder="10-20 位数字">
      </div>
      <div>
        <label>状态</label><br>
        <select id="f-status">
          <option value="">（全部）</option>
          <option value="运输中">运输中</option>
          <option value="已到达">已到达</option>
        </select>
      </div>
      <div>
        <label>备注关键词</label><br>
        <input id="f-remark" placeholder="模糊匹配">
      </div>
      <div>
        <label>是否带附件</label><br>
        <select id="f-has">
          <option value="">（不限）</option>
          <option value="true">有附件</option>
          <option value="false">无附件</option>
        </select>
      </div>
      <div>
        <label>开始时间</label><br>
        <input id="f-from" type="datetime-local">
      </div>
      <div>
        <label>结束时间</label><br>
        <input id="f-to" type="datetime-local">
      </div>
      <div>
        <button class="btn" id="btn-search">查询</button>
        <button class="btn ghost" id="btn-reset">重置</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="hint" class="muted">输入条件后点击查询。</div>
    <table id="tbl" style="display:none">
      <thead>
        <tr>
          <th>ID</th><th>DU ID</th><th>状态</th><th>备注</th><th>照片</th><th>时间</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pager" id="pager" style="display:none">
      <button class="ghost" id="prev">上一页</button>
      <span id="pginfo" class="muted"></span>
      <button class="ghost" id="next">下一页</button>
    </div>
  </div>
</div>

<script>
  const API_BASE = window.API_BASE || location.origin; // 默认同源
  function toAbsUrl(u){
    if(!u) return "";
    if(/^https?:\/\//i.test(u)) return u;           // 已是绝对地址
    const sep = u.startsWith("/") ? "" : "/";       // 相对路径 → 拼后端域名
    return `${API_BASE}${sep}${u}`;
  }

  const q = { page: 1, page_size: 20 };

  const el = id => document.getElementById(id);
  const tbl = el('tbl');
  const tbody = tbl.querySelector('tbody');
  const hint = el('hint');
  const pager = el('pager');
  const pginfo = el('pginfo');

  function buildParams(){
    const p = new URLSearchParams();
    const du = el('f-du').value.trim();
    const st = el('f-status').value;
    const rk = el('f-remark').value.trim();
    const hp = el('f-has').value;
    const df = el('f-from').value;
    const dt = el('f-to').value;

    if(du) p.set('du_id', du);
    if(st) p.set('status', st);
    if(rk) p.set('remark', rk);
    if(hp) p.set('has_photo', hp);
    if(df) p.set('date_from', new Date(df).toISOString());
    if(dt) p.set('date_to', new Date(dt).toISOString());
    p.set('page', q.page);
    p.set('page_size', q.page_size);
    return p.toString();
  }

  async function fetchList(){
    try{
      hint.textContent = '加载中…';
      tbl.style.display = 'none';
      pager.style.display = 'none';

      const url = `${API_BASE}/api/du/search?${buildParams()}`;
      const resp = await fetch(url);
      const raw = await resp.text();
      let data = null; try{ data = raw ? JSON.parse(raw) : null }catch{}
      if(!resp.ok){ throw new Error((data && (data.detail||data.message)) || ('HTTP '+resp.status)); }

      const items = Array.isArray(data?.items) ? data.items : [];
      tbody.innerHTML = items.map(it=>{
        const t = it.created_at ? new Date(it.created_at).toLocaleString() : '';
        const link = it.photo_url ? `<a href="${toAbsUrl(it.photo_url)}" target="_blank">查看</a>` : '';
        const remark = it.remark ? it.remark.replace(/[<>]/g,'') : '';
        return `<tr><td>${it.id}</td><td>${it.du_id}</td><td>${it.status}</td><td>${remark}</td><td>${link}</td><td>${t}</td></tr>`;
      }).join('');

      tbl.style.display = '';
      hint.textContent = items.length ? '' : '没有数据';

      const total = data?.total || 0;
      const pages = Math.max(1, Math.ceil(total / q.page_size));
      pginfo.textContent = `第 ${q.page} / ${pages} 页，共 ${total} 条`;
      pager.style.display = (pages > 1) ? '' : 'none';
      el('prev').disabled = (q.page <= 1);
      el('next').disabled = (q.page >= pages);
    }catch(err){
      hint.textContent = '查询失败：' + (err?.message || err);
      tbl.style.display = 'none';
      pager.style.display = 'none';
    }
  }

  el('btn-search').onclick = ()=>{ q.page = 1; fetchList(); };
  el('btn-reset').onclick = ()=>{
    ['f-du','f-status','f-remark','f-has','f-from','f-to'].forEach(id=>{
      const n = el(id);
      if(n.tagName === 'SELECT') n.value = '';
      else n.value = '';
    });
    q.page = 1; fetchList();
  };
  el('prev').onclick = ()=>{ if(q.page>1){ q.page--; fetchList(); }};
  el('next').onclick = ()=>{ q.page++; fetchList(); };
</script>
</body>
</html>
