<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Pemindaian - Pembaruan Status</title>
  <link rel="stylesheet" href="./styles.css" />
  <!-- Vue 3 & ZXing (全局 UMD) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/@zxing/browser@0.1.5"></script>

  <!-- 可选：在 HTML 里覆盖后端地址 -->
  <!-- <script>window.API_URL = "https://your-backend-service.com/api/du/update";</script> -->

  <script>
    // 禁用缩放
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());
    let __lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = Date.now();
      if (now - __lastTouchEnd <= 300) {
        const t = e.target;
        if (!t.closest('input, textarea, select, a, button, label, [role="button"]')) e.preventDefault();
      }
      __lastTouchEnd = now;
    }, { passive: false });
    window.addEventListener('wheel', function(e){ if (e.ctrlKey || e.metaKey) e.preventDefault(); }, { passive: false });
  </script>
</head>
<body>
  <div id="app" class="wrap">
    <!-- 语言切换 -->
    <div class="lang-switch">
      <button :class="{active: state.lang==='zh'}" @click="setLang('zh')" aria-label="Switch to Chinese">
        <img src="https://flagcdn.com/w20/cn.png" alt="CN" />中文
      </button>
      <button :class="{active: state.lang==='en'}" @click="setLang('en')" aria-label="Switch to English">
        <img src="https://flagcdn.com/w20/gb.png" alt="GB" />English
      </button>
      <button :class="{active: state.lang==='id'}" @click="setLang('id')" aria-label="Beralih ke Bahasa Indonesia">
        <img src="https://flagcdn.com/w20/id.png" alt="ID" />Indonesia
      </button>
    </div>

    <div><h1>{{ t('scanTitle') }}</h1></div>

    <!-- 只有在还没有有效 DID 的时候才显示扫码框 -->
    <section class="scan-area" v-if="!state.hasDid">
      <video ref="video" playsinline muted autoplay></video>
      <div class="corners">
        <div class="c tl"></div><div class="c tr"></div><div class="c bl"></div><div class="c br"></div>
      </div>
    </section>

    
    <!-- DID 手动输入区 -->
    <div class="did-input card" style="margin-top:12px">
      <label for="didInput" style="display:block;margin-bottom:6px">{{ t('didLabel') }}</label>
      <div class="did-row" style="display:flex;align-items:center;gap:8px">
        <span class="prefix mono" aria-hidden="true">DID</span>
        <input
          id="didInput"
          ref="didInput"
          class="mono"
          type="tel"
          inputmode="numeric"
          pattern="[0-9]*"
          maxlength="13"
          v-model="state.didDigits"
          @input="onDidInput"
          :placeholder="t('didPlaceholder')"
          aria-label="DID digits"
          enterkeyhint="done"
          style="flex:1"
        />
      </div>
    </div>


    <div class="tag" v-if="state.torchSupported">{{ t('torch') }}：<b>{{ state.torchOn ? t('on') : t('off') }}</b></div>

    <div class="row" v-if="!state.last">
      <button class="primary" @click="start" :disabled="state.running">{{ t('startScan') }}</button>
      <button class="ghost" @click="stop" :disabled="!state.running">{{ t('stop') }}</button>
      <button class="ghost" @click="toggleTorch" :disabled="!state.running || !state.torchSupported">{{ t('torchToggle') }}</button>
      <button class="ghost" @click="nextCamera" :disabled="!state.running">{{ t('switchCamera') || 'Switch Cam' }}</button>
    </div>
    
    <div class="card" v-if="state.hasDid">
      <div class="row">
        <button class="primary" @click="resume">{{ t('rescan') }}</button>
      </div>

      <template v-if="state.isValid">
        <div class="status-box">
          <div class="status-row" :class="{'shake': state.needsStatusShake}">
            <label for="duStatus">{{ t('updateStatus') }}：</label>
            <select
              id="duStatus"
              class="status"
              :class="{'invalid': state.needsStatusHint}"
              v-model="state.duStatus"
              aria-invalid="true"
              @change="state.needsStatusHint=false; state.needsStatusShake=false"
            >
              <option value="" disabled>{{ t('choose') }}</option>
              <!-- 后端仍收中文值 -->
              <option value="运输中">{{ t('inTransit') }}</option>
              <option value="过夜">{{ t('overnight') }}</option>
              <option value="已到达">{{ t('arrived') }}</option>
            </select>
          </div>
          <div class="hint" v-if="state.needsStatusHint">{{ t('needSelectStatus') }}</div>

          <div class="flex-2">
            <div class="col">
              <label style="display:block;margin-bottom:6px">{{ t('remark') }}</label>
              <textarea v-model="state.remark" :placeholder="t('remarkPlaceholder')"></textarea>
            </div>
            <div class="col">
              <label style="display:block;margin-bottom:6px">{{ t('uploadPhoto') }}</label>
              <div class="uploader">
                <img v-if="state.photoPreview" :src="state.photoPreview" alt="preview" class="thumb" />
                <div style="display:flex;flex-direction:column;gap:8px">
                  <input type="file" accept="image/*" capture="environment" @change="onPickPhoto" />
                  <small class="muted">{{ t('photoTip') }}</small>
                  <button v-if="state.photoFile" class="ghost" @click="clearPhoto">{{ t('removePhoto') }}</button>
                </div>
              </div>
            </div>
          </div>

          <button class="primary" style="align-self:flex-start" @click="submitUpdate" :disabled="!state.isValid || state.submitting">
            {{ state.submitting ? t('submitting') : t('submit') }}
          </button>

          <div v-if="state.submitting">
            <div class="progress" :class="{'indeterminate': !state.photoFile}">
              <div class="progress-bar" :style="{ width: (state.photoFile ? state.uploadPct : 100) + '%' }"></div>
            </div>
            <div class="progress-text">
              {{ state.photoFile ? (t('uploadingPct') + ' ' + state.uploadPct + '%') : t('submittingDots') }}
            </div>
          </div>

          <div v-if="state.submitMsg" :class="[state.submitOk ? 'ok' : 'err']">{{ state.submitMsg }}</div>
        </div>

        <!-- 提交成功后的结果展示 -->
        <div class="result-box" v-if="state.showResult">
          <h3>{{ t('submittedTitle') }}</h3>
          <div class="result-row"><span class="k">{{ t('duIdLabel') }}:</span><span class="v mono">{{ state.submitView.duId }}</span></div>
          <div class="result-row"><span class="k">{{ t('statusLabel') }}:</span><span class="v">{{ statusLabel(state.submitView.status) }}</span></div>
          <div class="result-row"><span class="k">{{ t('remarkLabel') }}:</span><span class="v">{{ state.submitView.remark || '-' }}</span></div>
          <div class="result-row" v-if="state.submitView.photo">
            <span class="k">{{ t('photoLabel') }}:</span>
            <img :src="state.submitView.photo" class="thumb" alt="thumb" />
          </div>
        </div>
      </template>

      <template v-else>
        <div class="err">{{ t('invalidId') }}</div>
      </template>
    </div>
  </div>

  <!-- 业务脚本：使用 ES Modules -->
  <script type="module" src="./i18n.js"></script>
  <script type="module" src="./app.js"></script>
</body>
</html>
