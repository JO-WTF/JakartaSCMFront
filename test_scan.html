<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>老手机优化版条形码扫描</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body { font-family: sans-serif; margin: 0; text-align: center; background: #111; color: #fff; }
    #video { width: 100%; height: auto; background: #000; }
    #result { margin: 15px 0; font-size: 20px; color: #0f0; word-break: break-all; }
  </style>
</head>
<body>
  <h2>📱 老手机优化条码扫描</h2>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="result">识别结果会显示在这里</div>

  <!-- ZXing-JS -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let resultDiv = document.getElementById('result');
    let lastResults = [];
    let stream;

    async function startScanner() {
      // 停掉已有摄像头
      if (stream) stream.getTracks().forEach(t => t.stop());

      // 自动对焦+分辨率约束
      let constraints = {
        video: {
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 },
          frameRate: { ideal: 15, max: 15 },
          focusMode: "continuous",
          advanced: [{ focusMode: "continuous" }]
        }
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      } catch (e) {
        console.warn("设备不支持 focusMode，回退默认摄像头", e);
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      }
      video.srcObject = stream;

      startZXing();
    }

    // ZXing 初始化
    function startZXing() {
      const codeReader = new ZXing.BrowserMultiFormatReader();
      const hints = new Map();
      const formats = [
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.CODE_39
      ];
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);

      function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          // 图像预处理：灰度化 + 对比度增强
          let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let data = imageData.data;
          for (let i = 0; i < data.length; i += 4) {
            let gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
            gray = gray > 128 ? 255 : 0; // 简单二值化
            data[i] = data[i+1] = data[i+2] = gray;
          }
          ctx.putImageData(imageData, 0, 0);

          // 解码
          codeReader.decodeFromCanvas(canvas, hints)
            .then(result => handleResult(result.text))
            .catch(err => {}); // 没识别到就跳过
        }
        setTimeout(tick, 66); // ~15fps
      }
      tick();
    }

    // 多帧确认逻辑
    function handleResult(text) {
      lastResults.push(text);
      if (lastResults.length > 5) lastResults.shift();

      // 如果最近 3 帧结果一致 → 输出
      if (lastResults.slice(-3).every(r => r === text)) {
        resultDiv.innerText = "识别结果: " + text;
      }
    }

    // 启动
    startScanner();
  </script>
</body>
</html>
