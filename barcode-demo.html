<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>扫码 Demo（对接后端）</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    video { width: 100%; max-width: 480px; border: 1px solid #ccc; margin: 10px 0; }
    select, button, textarea, input[type=file] { margin: 6px; padding: 8px; font-size: 14px; }
    #result { margin-top: 10px; font-weight: bold; color: #333; }
    .ok { color: #15a362; }
    .err { color: #d93025; }
    .card { max-width: 560px; margin: 0 auto; text-align: left; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .field { margin-top: 8px; }
    .field label { display: block; font-weight: 600; margin-bottom: 4px; }
    .status-line { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .bottom { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>二维码扫码 Demo</h1>
  <p>请选择摄像头并点击开始扫码</p>

  <select id="cameraSelect"></select>
  <br>
  <button id="startButton">开始扫码</button>
  <button id="resetButton">停止</button>

  <div>
    <video id="video" autoplay muted playsinline></video>
  </div>

  <div id="result">扫描结果会显示在这里</div>

  <div id="panel" class="card" style="display:none">
    <div class="row">
      <button id="rescanBtn">重新扫描</button>
    </div>
    <div class="field">
      <label>识别结果</label>
      <div id="scanText" style="font-family: ui-monospace, Menlo, Consolas, monospace;"></div>
      <div id="validHint" class="err" style="display:none">无效的DU ID（需 10–20 位纯数字）</div>
    </div>

    <div id="formArea" style="display:none">
      <div class="field">
        <div class="status-line">
          <label for="statusSel" style="margin:0">更新 DU 状态：</label>
          <select id="statusSel">
            <option value="" selected disabled>请选择</option>
            <option value="运输中">运输中</option>
            <option value="已到达">已到达</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="remark">备注信息</label>
        <textarea id="remark" rows="3" placeholder="可填写额外说明…"></textarea>
      </div>

      <div class="field">
        <label for="photo">上传照片（可拍照或相册）</label>
        <input id="photo" type="file" accept="image/*" capture="environment">
        <div id="photoName" style="font-size:12px;color:#555"></div>
      </div>

      <div class="bottom">
        <button id="submitBtn">提交</button>
        <span id="submitMsg" style="margin-left:8px;"></span>
      </div>
    </div>
  </div>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@0.18.6"></script>
  <script>
    const API_URL = "https://backend-jwsj.onrender.com/api/du/update";

    const codeReader = new ZXing.BrowserMultiFormatReader();
    const videoElement = document.getElementById('video');
    const cameraSelect = document.getElementById('cameraSelect');
    const resultElement = document.getElementById('result');
    const startButton = document.getElementById('startButton');
    const resetButton = document.getElementById('resetButton');

    const panel = document.getElementById('panel');
    const rescanBtn = document.getElementById('rescanBtn');
    const scanText = document.getElementById('scanText');
    const validHint = document.getElementById('validHint');
    const formArea = document.getElementById('formArea');
    const statusSel = document.getElementById('statusSel');
    const remark = document.getElementById('remark');
    const photo = document.getElementById('photo');
    const photoName = document.getElementById('photoName');
    const submitBtn = document.getElementById('submitBtn');
    const submitMsg = document.getElementById('submitMsg');

    let selectedDeviceId = null;
    let running = false;
    const DU_RE = /^\d{10,20}$/;

    function setUIIdle() {
      panel.style.display = 'none';
      resultElement.textContent = '已停止扫描';
      submitMsg.textContent = '';
      statusSel.value = '';
      remark.value = '';
      photo.value = '';
      photoName.textContent = '';
    }

    function setUIAfterScan(text, isValid) {
      panel.style.display = 'block';
      scanText.textContent = text;
      validHint.style.display = isValid ? 'none' : 'block';
      formArea.style.display = isValid ? 'block' : 'none';
      submitMsg.textContent = '';
      resultElement.textContent = isValid ? '扫描成功' : '扫描结果无效';
    }

    function pickDefaultBackCamera(devices) {
      // 优先挑 label 中包含 back / rear / environment 的
      const backLike = devices.find(d => /back|rear|environment/i.test(d.label));
      return (backLike && backLike.deviceId) || (devices[0] && devices[0].deviceId) || null;
    }

    // 列出摄像头并默认选后置
    codeReader.listVideoInputDevices().then(videoInputDevices => {
      if (videoInputDevices.length === 0) {
        alert("没有检测到摄像头！");
        return;
      }
      cameraSelect.innerHTML = '';
      videoInputDevices.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `摄像头 ${index + 1}`;
        cameraSelect.appendChild(option);
      });
      selectedDeviceId = pickDefaultBackCamera(videoInputDevices);
      if (selectedDeviceId) cameraSelect.value = selectedDeviceId;
      cameraSelect.onchange = () => { selectedDeviceId = cameraSelect.value; };
    }).catch(console.error);

    // 开始扫码
    startButton.addEventListener('click', () => {
      if (!selectedDeviceId) {
        resultElement.textContent = "未找到摄像头";
        return;
      }
      if (running) return;
      running = true;
      resultElement.textContent = "正在扫描...";
      panel.style.display = 'none';
      submitMsg.textContent = '';

      codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err, controls) => {
        if (result) {
          // 命中即停
          try { controls.stop(); } catch(e){}
          try { codeReader.reset(); } catch(e){}
          running = false;

          const text = result.getText();
          const isValid = DU_RE.test(text);
          setUIAfterScan(text, isValid);
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error(err);
        }
      });
    });

    // 停止扫码
    resetButton.addEventListener('click', () => {
      try { codeReader.reset(); } catch(e){}
      running = false;
      setUIIdle();
    });

    // 重新扫描
    rescanBtn.addEventListener('click', () => {
      setUIIdle();
      startButton.click();
    });

    // 照片名显示
    photo.addEventListener('change', () => {
      const f = photo.files && photo.files[0];
      photoName.textContent = f ? `已选择：${f.name}` : '';
    });

    // 提交到后端
    submitBtn.addEventListener('click', async () => {
      submitMsg.textContent = '';
      submitMsg.className = '';
      const duText = scanText.textContent.trim();
      if (!DU_RE.test(duText)) {
        submitMsg.textContent = '无效的DU ID';
        submitMsg.className = 'err';
        return;
      }
      if (!statusSel.value) {
        submitMsg.textContent = '请选择要更新的状态';
        submitMsg.className = 'err';
        return;
      }

      const fd = new FormData();
      fd.append('duId', duText);
      fd.append('status', statusSel.value);
      fd.append('remark', remark.value || '');
      if (photo.files && photo.files[0]) fd.append('photo', photo.files[0]);

      submitBtn.disabled = true;
      submitBtn.textContent = '提交中…';

      try {
        if (!API_URL || /<你的-render-域名>/.test(API_URL)) {
          // 占位地址：做本地模拟
          await new Promise(r => setTimeout(r, 600));
          submitMsg.textContent = '提交成功（本地演示——请配置 API_URL）';
          submitMsg.className = 'ok';
        } else {
          const resp = await fetch(API_URL, { method: 'POST', body: fd });
          const text = await resp.text();
          let data = null;
          try { data = text ? JSON.parse(text) : null; } catch(e){}

          if (!resp.ok) {
            const msg = (data && (data.detail || data.message)) || ('HTTP ' + resp.status);
            throw new Error(msg);
          }
          const ok = (data && (data.ok === true || data.success === true)) || resp.ok;
          submitMsg.textContent = ok ? (data?.message || '提交成功') : (data?.message || '提交失败');
          submitMsg.className = ok ? 'ok' : 'err';

          if (ok) {
            // 成功后自动回到扫描（也可去掉这段）
            setTimeout(() => { rescanBtn.click(); }, 600);
          }
        }
      } catch (err) {
        console.error(err);
        submitMsg.textContent = '提交失败：' + (err?.message || err);
        submitMsg.className = 'err';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '提交';
      }
    });
  </script>
</body>
</html>
