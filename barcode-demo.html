<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>条码扫码 Demo (ZXing)</title>
  <script src="https://unpkg.com/@zxing/browser"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 10px; margin: 0; background: #f8f8f8; }
    h2 { font-size: 1.4em; margin-bottom: 0.6em; }
    #video-area { width: 100vw; max-width: 360px; margin: auto; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); background: #fff; overflow: hidden; display:none;}
    #video { width: 100%; max-width: 360px; height: 240px; background: #222; border-radius: 10px; object-fit: cover;}
    #result { margin-top: 18px; font-size: 1.1em; font-weight: bold; color: green; word-break: break-all; display:none;}
    #order-status-area { margin-top: 18px; }
    #order-status-label { margin-right: 8px; font-size: 1em; }
    select { font-size: 1em; padding: 6px 12px; border-radius: 6px; border: 1px solid #ccc; background: #fff; margin-top: 6px; max-width: 80vw;}
    @media (max-width: 480px) { #video-area { width: 96vw; max-width: 96vw; min-width: 220px; } #video { max-width: 96vw; height: 180px; } select { font-size: 1em; padding: 8px 10px; } }
    button { margin-top: 18px; font-size: 1em; padding: 8px 20px; border-radius: 6px; border: none; background: #2d6cf6; color: #fff; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.08);}
    button:active { background: #1542a0; }
    #tip { color: #d00; margin-top: 10px; font-size: 0.98em;}
  </style>
</head>
<body>
  <h2>条码扫码 Demo (ZXing)</h2>
  <p style="font-size:1em;">请将条形码或二维码对准摄像头</p>
  <button id="start-btn">开始扫码</button>
  <div id="video-area">
    <video id="video" autoplay muted playsinline></video>
  </div>
  <div id="tip"></div>
  <div id="result">等待扫描...</div>
  <div id="order-status-area" style="display:none;">
    <span id="order-status-label">修改订单状态：</span>
    <select id="order-status-select">
      <option value="">请选择状态</option>
      <option value="运输中">运输中</option>
      <option value="已到达">已到达</option>
      <option value="已签收">已签收</option>
    </select>
  </div>
  <button id="restart-btn" style="display:none;">重新扫码</button>

  <script>
    function validateBarcode(barcode) {
      // 校验规则：纯数字，长度10-20
      return /^\d{10,20}$/.test(barcode);
    }

    let codeReader, controls;

    async function startScanner() {
      document.getElementById("start-btn").style.display = "none";
      document.getElementById("video-area").style.display = "block";
      document.getElementById("result").style.display = "block";
      document.getElementById("result").innerText = "等待扫描...";
      document.getElementById("tip").innerText = "";
      document.getElementById("order-status-area").style.display = "none";
      document.getElementById("restart-btn").style.display = "none";
      if (controls) {
        await controls.stop();
        controls = null;
      }

      codeReader = new ZXing.BrowserMultiFormatReader();
      const videoElem = document.getElementById('video');
      // 固定后置摄像头
      const constraints = { video: { facingMode: { exact: "environment" } } };
      try {
        await navigator.mediaDevices.getUserMedia(constraints);
      } catch (e) {
        document.getElementById("tip").innerText = "无法访问摄像头，请检查浏览器权限设置，并允许摄像头访问！";
        return;
      }
      try {
        controls = await codeReader.decodeFromVideoDevice(
          null,
          videoElem,
          (result, err) => {
            if (result) {
              document.getElementById("result").innerText = "识别结果: " + result.text;
              if (validateBarcode(result.text)) {
                document.getElementById("order-status-area").style.display = "block";
              } else {
                document.getElementById("order-status-area").style.display = "none";
              }
              // 扫到一次就停
              controls.stop();
              document.getElementById("restart-btn").style.display = "inline-block";
            } else if (err && !(err instanceof ZXing.NotFoundException)) {
              document.getElementById("result").innerText = "扫码错误: " + err;
            }
          },
          constraints.video
        );
      } catch (e) {
        document.getElementById("tip").innerText = "启动失败: " + e;
      }
    }

    document.getElementById("start-btn").onclick = startScanner;
    document.getElementById("restart-btn").onclick = startScanner;
  </script>
</body>
</html>
